{% extends "layouts/page.njk" %}

{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "page-body/macro.njk" import appPageBody %}
{% from "editor-card/macro.njk" import appEditorCard %}

{% block beforeContent %}
  <div class="govuk-width-container app-width-container--wide">
    {{ govukBackLink(backLink) }}
  </div>
{% endblock %}

{% set mainClasses = "govuk-main-wrapper--masthead" %}

{% block content %}
{% call appPageBody({
  errorList: errorList,
  heading: pageHeading,
  description: pageDescription,
  classes: "govuk-grid-column-full",
  useNewMasthead: true
}) %}

  {% if successMessage %}
    <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
          Success
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-notification-banner__heading">
          {{ successMessage }}
        </p>
      </div>
    </div>
  {% endif %}

  {% if errorMessage %}
    <div class="govuk-notification-banner" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
          Important
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-notification-banner__heading">
          {{ errorMessage }}
        </p>
      </div>
    </div>
  {% endif %}

  <div class="govuk-grid-column-one-half-from-desktop">
    {% call appEditorCard({
      title: "Describe your form",
      caption: "Step 2 of 3"
    }) %}
      <form method="post" novalidate id="describe-form">
        {{ govukTextarea({
          label: {
            text: field.label.text,
            classes: "govuk-label--m"
          },
          hint: {
            text: field.hint.text
          },
          id: field.id,
          name: field.name,
          rows: field.rows,
          value: field.value,
          errorMessage: {
            text: formErrors[field.name].text
          } if formErrors[field.name]
        }) }}

        {{ govukDetails({
          summaryText: examplesContent.title,
          html: '
            <h3 class="govuk-heading-s">Good examples:</h3>
            <ul class="govuk-list govuk-list--bullet">
              <li><strong>Dog breeding license application:</strong><br>I need a form to register dog breeders. Collect owner details, business address, number of dogs, and breeding experience. Show additional questions about premises only if they breed more than 5 dogs.</li>
              <li><strong>Planning application:</strong><br>Create a planning application form. Need property address, applicant details, project description, and file uploads for plans. Include yes/no questions about listed buildings and conservation areas.</li>
              <li><strong>Dangerous dogs registration:</strong><br>Create a form to register dangerous dogs. Need owner details, dog breed and description, insurance details, and vet information. Include conditional questions about previous incidents only if the owner has had dogs before.</li>
            </ul>
            <h3 class="govuk-heading-s">Tips for better results:</h3>
            <ul class="govuk-list govuk-list--bullet">
              <li>Mention any conditional logic (show X if Y is selected)</li>
              <li>Specify required vs optional fields</li>
              <li>Include validation requirements (email format, number ranges, etc.)</li>
              <li>Mention any lists of options (dropdowns, radio buttons)</li>
              <li>Describe the purpose and who will use the form</li>
              <li>Include any specific formatting or layout preferences</li>
            </ul>
          '
        }) }}

        <div id="form-buttons" class="govuk-button-group">
          <form method="post" action="/create/ai-describe/evaluate" style="display: inline;">
            <input type="hidden" name="formDescription" id="evaluate-description" value="">
            {{ govukButton({
              text: "Evaluate my description",
              classes: "govuk-button--secondary",
              attributes: { id: "evaluate-btn", type: "submit" }
            }) }}
          </form>

          {{ govukButton({
            text: buttonText,
            classes: "govuk-button--primary",
            attributes: { id: "generate-form-btn" }
          }) }}

          {{ govukButton({
            text: alternativeAction.text,
            href: alternativeAction.href,
            classes: "govuk-button--secondary"
          }) }}
        </div>
      </form>
    {% endcall %}
  </div>

  <div class="govuk-grid-column-one-half-from-desktop">
    {% if gdsAnalysis %}
      <div class="app-feedback-panel">
        {% call appEditorCard({
          title: "GDS Compliance Feedback",
          caption: "AI Analysis"
        }) %}
          <div class="govuk-inset-text">
            <p class="govuk-body"><strong>GDS Compliance Score:</strong> {{ gdsAnalysis.analysis.overallScore }}/10</p>
          </div>

          {% if gdsAnalysis.analysis.feedback and gdsAnalysis.analysis.feedback.length > 0 %}
            <h3 class="govuk-heading-s">Suggestions for improvement:</h3>
            
            {% for item in gdsAnalysis.analysis.feedback %}
              <div class="govuk-warning-text">
                <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                <strong class="govuk-warning-text__text">
                  <span class="govuk-warning-text__assistive">Warning</span>
                  {{ item.issue }}
                </strong>
              </div>
              <div class="govuk-inset-text">
                <p class="govuk-body"><strong>Suggestion:</strong> {{ item.suggestion }}</p>
              </div>
            {% endfor %}

            <form method="post" action="/create/ai-describe/apply-suggestions" class="govuk-!-margin-top-4">
              <input type="hidden" name="refinedDescription" value="{{ gdsAnalysis.refinedDescription }}">
              
              <div class="govuk-button-group">
                {{ govukButton({
                  text: "Apply suggestions",
                  classes: "govuk-button--primary"
                }) }}

                <a href="/create/ai-describe" class="govuk-button govuk-button--secondary">
                  Hide feedback
                </a>
              </div>
            </form>
          {% else %}
            <p class="govuk-body">Your description looks good! No specific improvements needed.</p>
            <a href="/create/ai-describe" class="govuk-button govuk-button--secondary">
              Hide feedback
            </a>
          {% endif %}
        {% endcall %}
      </div>
    {% endif %}
  </div>

{% endcall %}
{% endblock %}

{% block mainEnd %}
  {{ super() }}
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .ai-spinner {
      animation: spin 1s linear infinite !important;
    }
    
    .loading-state {
      pointer-events: none;
      opacity: 0.6;
    }

    .app-feedback-panel {
      position: sticky;
      top: 20px;
    }

    .app-loading {
      text-align: center;
      padding: 20px;
    }

    .app-loading::before {
      content: "⟳";
      display: inline-block;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      font-size: 1.2em;
    }



    .success-state {
      border-color: #00703c !important;
      box-shadow: 0 0 0 3px #00703c40;
      transition: all 0.3s ease;
    }

    .success-state::after {
      content: "✓";
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      color: #00703c;
      font-size: 1.5em;
      font-weight: bold;
      z-index: 1;
    }

    #refinement-notification {
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
  <script type="module" src="{{ getAssetPath("ai-form-creation.js") }}"></script>
{% endblock %} 